---
title: "Creating and Using Agent Networks | Network Documentation | Mastra"
description: Overview of agent networks in Mastra, detailing how to create, configure, and use networks of specialized agents that work together to solve complex tasks.
---

# Creating and Using Agent Networks

Agent Networks in Mastra allow you to create and orchestrate networks of specialized agents that work together to solve complex tasks. Each agent in the network can focus on a specific aspect of a problem, with a router determining which agent to call next based on the current state and previous results.

Networks are ideal for complex workflows where different specialized skills are needed at different stages of a task, or when you want to break down a complex problem into smaller, more manageable parts.

## 1. Creating a Network

To create an agent network in Mastra, you use the `AgentNetwork` class and define its properties:

```ts showLineNumbers filename="src/mastra/networks/index.ts" copy
import { AgentNetwork } from "@mastra/core/network";
import { Agent } from "@mastra/core/agent";
import { openai } from "@ai-sdk/openai";

// Create specialized agents
const researchAgent = new Agent({
  name: "Research",
  instructions: "You search for and gather information on topics",
  model: openai("gpt-4o"),
});

const summaryAgent = new Agent({
  name: "Summary",
  instructions: "You summarize information into concise points",
  model: openai("gpt-4o"),
});

// Create a network with a custom router
export const researchNetwork = new AgentNetwork({
  name: "Research Assistant",
  agents: [researchAgent, summaryAgent],
  routingModel: openai("gpt-4o"),
  router: async ({ callCount }) => {
    if (callCount === 0) return researchAgent;
    if (callCount === 1) return summaryAgent;
    return undefined; // Done after two calls
  },
});
```

**Note:** Ensure that you have set the necessary environment variables, such as your OpenAI API key, in your `.env` file:

```.env filename=".env" copy
OPENAI_API_KEY=your_openai_api_key
```

Also, make sure you have the `@mastra/core` package installed:

```bash npm2yarn copy
npm install @mastra/core
```

### Registering the Network

Register your network with Mastra to enable logging and access to configured tools and integrations:

```ts showLineNumbers filename="src/mastra/index.ts" copy
import { Mastra } from "@mastra/core";
import { researchNetwork } from "./networks";

export const mastra = new Mastra({
  networks: { researchNetwork },
});
```

## 2. Using a Network

Once you've created a network, you can use it to generate responses:

```ts showLineNumbers filename="src/app/api/research/route.ts" copy
import { researchNetwork } from "@/mastra/networks";

export async function POST(req: Request) {
  const { query } = await req.json();
  
  // Generate a response from the network
  const result = await researchNetwork.generate(query);
  
  return Response.json({ result: result.output });
}
```

### Network Results

The `generate` method returns a `NetworkResult` object with the following properties:

- `output`: The final output from the network
- `steps`: Number of steps executed
- `history`: Array of step results, each containing:
  - `agent`: Name of the agent that was called
  - `input`: Input that was passed to the agent
  - `output`: Output from the agent
  - `timestamp`: When the step was executed
  - `step`: Step number
  - `state`: State of the network at that point

## 3. Network Configuration Options

When creating a network, you can configure several options:

```ts showLineNumbers copy
const network = new AgentNetwork({
  // Required options
  name: "My Network",
  agents: [agent1, agent2, agent3],
  
  // Either router or routingModel is required
  router: async ({ callCount, state, lastResult, input }) => {
    // Custom routing logic
    return callCount < 2 ? agent1 : undefined;
  },
  routingModel: openai("gpt-4o"), // Used if no router function is provided
  
  // Optional settings
  initialState: new NetworkState({ counter: 0 }), // Initial state
  maxSteps: 5, // Maximum number of steps (default: 10)
  logger: customLogger, // Custom logger
});
```

## 4. Advanced Network Features

Agent Networks provide several advanced features:

### Message-Based Input

Networks can accept either string inputs or arrays of `CoreMessage` objects:

```ts copy
// String input
const result1 = await network.generate("Research quantum computing");

// Message-based input
const result2 = await network.generate([
  { role: "user", content: "I need information about quantum computing." },
  { role: "assistant", content: "I can help with that. What specific aspects are you interested in?" },
  { role: "user", content: "Focus on recent breakthroughs in the last 2 years." },
]);
```

### Custom Run IDs

You can provide custom IDs for tracking and telemetry:

```ts copy
const result = await network.generate("Process this data", {
  runId: "custom-run-id",
  threadId: "custom-thread-id",
  resourceId: "custom-resource-id",
  maxSteps: 3, // Override the default maximum steps
});
```

### Streaming Responses

For real-time updates during network execution, use the `stream` method:

```ts copy
const streamResult = await network.stream("Research quantum computing", {
  onStepStart: (agent, step) => console.log(`Starting step ${step} with ${agent.name}`),
  onStepFinish: (result) => console.log(`Finished step with output: ${result.output}`),
  onFinish: (result) => console.log(`Network execution complete with ${result.steps} steps`),
});

// Process the stream
for await (const chunk of streamResult.stream) {
  if (chunk.type === "agentChunk") {
    process.stdout.write(chunk.chunk); // Display incremental output
  }
}

// Get the final result
const finalResult = await streamResult.done();
```

## 5. Best Practices

- **Specialized Agents**: Design each agent with a specific role and clear instructions
- **Efficient Routing**: Keep routing logic simple and deterministic
- **State Management**: Use state to share information between agents
- **Error Handling**: Implement proper error handling in your router function
- **Timeout Management**: Set appropriate `maxSteps` to prevent infinite loops

## Next Steps

- Learn about [Custom Routing](./01-custom-routing.mdx) for more advanced routing strategies
- Explore [State Management](./02-state-management.mdx) to share data between agents
- Discover [Streaming](./03-streaming.mdx) for real-time updates during network execution
